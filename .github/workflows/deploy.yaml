name: Deploy FilterFacts to Naver Cloud Kubernetes

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------------
      # 1) Checkout
      # ------------------------------------------------
      - name: Checkout source
        uses: actions/checkout@v4

      # ------------------------------------------------
      # 2) Build Docker Image (Backend)
      # ------------------------------------------------
      - name: Build Docker Image (Backend)
        id: build
        run: |
          IMAGE=${{ secrets.NCP_REGISTRY_URL }}/filterfacts-backend
          TAG=$(date +'%Y%m%d-%H%M%S')
          echo "TAG=$TAG" >> $GITHUB_ENV

          echo "${{ secrets.NCP_REGISTRY_PASSWORD }}" | docker login \
            -u "${{ secrets.NCP_REGISTRY_USERNAME }}" \
            --password-stdin ${{ secrets.NCP_REGISTRY_URL }}

      # 수정 포인트: --no-cache 제거 및 buildx 캐시 옵션 추가
          docker build \
            --push \
            -t $IMAGE:$TAG \
            --cache-from=type=gha \
            --cache-to=type=gha,mode=max

      # ------------------------------------------------
      # 3) Install Naver Cloud IAM Authenticator
      # ------------------------------------------------
      - name: Install Naver Cloud IAM Authenticator
        run: |
          ARCH=$(uname -m)
          if [ "$ARCH" = "x86_64" ]; then
            FILE_URL="https://github.com/NaverCloudPlatform/ncp-iam-authenticator/releases/download/v1.1.1/ncp-iam-authenticator_linux_amd64"
          else
            FILE_URL="https://github.com/NaverCloudPlatform/ncp-iam-authenticator/releases/download/v1.1.1/ncp-iam-authenticator_linux_arm64"
          fi

          curl -fL -o ncp-iam-authenticator ${FILE_URL}
          chmod +x ncp-iam-authenticator
          sudo mv ncp-iam-authenticator /usr/local/bin/

      # ------------------------------------------------
      # 4) Restore IAM Config
      # ------------------------------------------------
      - name: Restore Naver Cloud IAM Config
        run: |
          mkdir -p $HOME/.ncloud
          echo "${{ secrets.NCP_CONFIG }}" | base64 --decode > $HOME/.ncloud/configure
          chmod 600 $HOME/.ncloud/configure

      # ------------------------------------------------
      # 5) Restore Kubeconfig
      # ------------------------------------------------
      - name: Restore kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.NKS_KUBECONFIG1 }}" | base64 --decode > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      # ------------------------------------------------
      # 7) Apply Secret
      # ------------------------------------------------
      - name: Apply Application Secrets
        run: |
          echo "${{ secrets.FF_SECRET_FILE }}" | base64 --decode > f-f-secret.yaml
          kubectl apply -f f-f-secret.yaml

      # ------------------------------------------------
      # 8) Inject TAG into backend-deploy.yaml
      # ------------------------------------------------
      - name: Inject TAG into Backend Deployment YAML
        run: |
         echo "===== BEFORE SED ====="
          cat k8s/backend-deploy.yaml
          
          sed -i "s|__TAG__|$TAG|g" k8s/backend-deploy.yaml
         
         echo "===== AFTER SED ====="
         cat k8s/backend-deploy.yaml

      # ------------------------------------------------
      # 9) Apply Backend Deployment (TAG already included)
      # ------------------------------------------------
      - name: Apply Backend Deployment with TAG
        run: |
          kubectl apply -f k8s/backend-deploy.yaml -n filterfacts
          kubectl rollout status deployment/f-f-backend -n filterfacts --timeout=200s

      # ------------------------------------------------
      # 10) Final Status Check
      # ------------------------------------------------
      - name: Verify Deployment Status
        run: |
          kubectl get pods -o wide
          kubectl get svc
