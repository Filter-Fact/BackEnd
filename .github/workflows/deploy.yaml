name: Deploy FilterFacts to Naver Cloud Kubernetes

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout
      - name: Checkout source
        uses: actions/checkout@v4

      # 2) JDK (ë©€í‹° ìŠ¤í…Œì´ì§€ Dockerfile ì‚¬ìš©í•˜ì§€ ì•Šì„ ê²½ìš° í•„ìš”)
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # 3) Build JAR
      - name: Build with Gradle
        run: |
          chmod +x gradlew
          ./gradlew clean build -x test

      # 4) Build & Push Docker Image
      - name: Build and Push Backend Docker image
        id: build
        run: |
          IMAGE=${{ secrets.NCP_REGISTRY_URL}}/filterfacts-backend
          TAG=$(date +'%Y%m%d-%H%M%S')
          echo "TAG=$TAG" >> $GITHUB_ENV

          echo "${{ secrets.NCP_REGISTRY_PASSWORD }}" | docker login \
            -u "${{ secrets.NCP_REGISTRY_USERNAME }}" \
            --password-stdin   refactoring-registry.kr.ncr.ntruss.com

          docker build -t $IMAGE:$TAG -t $IMAGE:latest .
          docker push $IMAGE:$TAG
          docker push $IMAGE:latest

      # 5) Install IAM Authenticator
      - name: Install Naver Cloud IAM Authenticator
        run: |
          ARCH=$(uname -m)
          if [ "$ARCH" = "x86_64" ]; then
            FILE_URL="https://github.com/NaverCloudPlatform/ncp-iam-authenticator/releases/download/v1.1.1/ncp-iam-authenticator_linux_amd64"
          else
            FILE_URL="https://github.com/NaverCloudPlatform/ncp-iam-authenticator/releases/download/v1.1.1/ncp-iam-authenticator_linux_arm64"
          fi

          curl -fL -o ncp-iam-authenticator ${FILE_URL}
          chmod +x ncp-iam-authenticator
          sudo mv ncp-iam-authenticator /usr/local/bin/

      # 6) Restore Ncloud Config
      - name: Restore Naver Cloud config
        run: |
          mkdir -p $HOME/.ncloud
          echo "${{ secrets.NCP_CONFIG }}" | base64 --decode > $HOME/.ncloud/configure
          chmod 600 $HOME/.ncloud/configure

      - name: Restore kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.NKS_KUBECONFIG1 }}" | base64 --decode > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      # 7) Apply Secret (ðŸ”¥ í•µì‹¬: GitHub Secretsì—ì„œ Secret íŒŒì¼ ë³µì›)
      - name: Apply K8S Secret (f-f-secret.yaml)
        run: |
          echo "${{ secrets.FF_SECRET_FILE }}" | base64 --decode > f-f-secret.yaml
          kubectl apply -f f-f-secret.yaml

      # 8) Apply All Kubernetes Deployment YAMLs (Multi-service)
      - name: Apply K8S Deployments
        run: |
          kubectl apply -f k8s/backend/
          kubectl apply -f k8s/postgres/
          kubectl apply -f k8s/redis/
          kubectl apply -f k8s/fastapi/

      # 9) Update Backend Image
      - name: Deploy Backend With Updated Image Tag
        run: |
          kubectl set image deployment/f-f-backend \
            f-f-backend=refactoring-registry.kr.ncr.ntruss.com/filterfacts-backend:$TAG \
            --record
          kubectl rollout status deployment/f-f-backend --timeout=200s

      # 10) Status Check
      - name: Verify Deployment Status
        run: |
          kubectl get pods -o wide
          kubectl get svc
