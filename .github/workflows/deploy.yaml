name: Deploy FilterFacts to Naver Cloud Kubernetes

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------------
      # 1) Checkout
      # ------------------------------------------------
      - name: Checkout source
        uses: actions/checkout@v4

      # ------------------------------------------------
      # 2) Build Backend JAR (Dockerfile builder stage)
      # ------------------------------------------------
      # ⛔ JDK 설치 필요 없음 — Dockerfile 내부에서 gradle build 수행함
      - name: Build Docker Image (Backend)
        id: build
        run: |
          IMAGE=${{ secrets.NCP_REGISTRY_URL }}/filterfacts-backend
          TAG=$(date +'%Y%m%d-%H%M%S')
          echo "TAG=$TAG" >> $GITHUB_ENV

          echo "${{ secrets.NCP_REGISTRY_PASSWORD }}" | docker login \
            -u "${{ secrets.NCP_REGISTRY_USERNAME }}" \
            --password-stdin refactoring-registry.kr.ncr.ntruss.com

          docker build -t $IMAGE:$TAG -t $IMAGE:latest .
          docker push $IMAGE:$TAG
          docker push $IMAGE:latest

      # ------------------------------------------------
      # 3) Install Naver Cloud IAM Authenticator
      # ------------------------------------------------
      - name: Install Naver Cloud IAM Authenticator
        run: |
          ARCH=$(uname -m)
          if [ "$ARCH" = "x86_64" ]; then
            FILE_URL="https://github.com/NaverCloudPlatform/ncp-iam-authenticator/releases/download/v1.1.1/ncp-iam-authenticator_linux_amd64"
          else
            FILE_URL="https://github.com/NaverCloudPlatform/ncp-iam-authenticator/releases/download/v1.1.1/ncp-iam-authenticator_linux_arm64"
          fi
          curl -fL -o ncp-iam-authenticator ${FILE_URL}
          chmod +x ncp-iam-authenticator
          sudo mv ncp-iam-authenticator /usr/local/bin/

      # ------------------------------------------------
      # 4) Restore IAM Config (~/.ncloud/configure)
      # ------------------------------------------------
      - name: Restore Naver Cloud IAM Config
        run: |
          mkdir -p $HOME/.ncloud
          echo "${{ secrets.NCP_CONFIG }}" | base64 --decode > $HOME/.ncloud/configure
          chmod 600 $HOME/.ncloud/configure

      # ------------------------------------------------
      # 5) Restore Kubeconfig (~/.kube/config)
      # ------------------------------------------------
      - name: Restore kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.NKS_KUBECONFIG1 }}" | base64 --decode > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      # ------------------------------------------------
      # 6) Test Kubernetes Connection
      # ------------------------------------------------
      - name: Test NKS Connection
        run: |
          kubectl get nodes

      # ------------------------------------------------
      # 7) Apply Secret (f-f-secret.yaml)
      # ------------------------------------------------
      - name: Apply Application Secrets
        run: |
          echo "${{ secrets.FF_SECRET_FILE }}" | base64 --decode > f-f-secret.yaml
          kubectl apply -f f-f-secret.yaml

      # ------------------------------------------------
      # 8) Apply All Deployments
      # ------------------------------------------------
      - name: Apply All Kubernetes Deployments
        run: |
          kubectl apply -f k8s/

      # ------------------------------------------------
      # 9) Update Backend Deployment with New Image
      # ------------------------------------------------
      - name: Deploy Backend With Updated Image Tag
        run: |
          kubectl set image deployment/f-f-backend \
            f-f-backend=${{ secrets.NCP_REGISTRY_URL }}/filterfacts-backend:$TAG \
            --record
          kubectl rollout status deployment/f-f-backend --timeout=200s

      # ------------------------------------------------
      # 10) Final Status Check
      # ------------------------------------------------
      - name: Verify Deployment Status
        run: |
          kubectl get pods -o wide
          kubectl get svc
